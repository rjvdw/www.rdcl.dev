---
import { updateAuthenticator } from '$lib/auth/profileApi'
import { checkJwtOrRedirect } from '$lib/auth/util'

const jwt = checkJwtOrRedirect(Astro)
if (jwt instanceof Response) {
  return jwt
}

if (Astro.request.method !== 'POST') {
  return new Response('invalid method', {
    status: 405,
    headers: {
      'Content-Type': 'text/plain',
    },
  })
}

const { id } = Astro.params
const data = await Astro.request.formData()
const name = data.get('name') || null

if (name !== undefined && typeof name !== 'string') {
  return new Response('invalid name', {
    status: 400,
    headers: {
      'Content-Type': 'text/plain',
    },
  })
}

await updateAuthenticator(jwt, id!, name)

return Astro.redirect('/profile')
---
